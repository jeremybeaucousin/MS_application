<%@page import="base.TablePersonne"%>
<%@page import="vues.IEcranPersonne"%>
<%@page import="parametrage.Personne"%>
<%@page import="parametrage.Libelle"%>
<%@page import="java.util.ArrayList"%>
<%@page import="java.util.Hashtable"%>
<%@ page language="java" contentType="text/html; charset=ISO-8859-1"
    pageEncoding="ISO-8859-1"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Personne</title>
</head>
<body>
	<% 
	//initialisation des variables
	String recherche="",ecran=(String)session.getAttribute(IEcranPersonne.ATTR_ECRAN).toString();
	
	if(session.getAttribute(IEcranPersonne.ATTR_RECHERCHE)!=null) recherche=(String)session.getAttribute(IEcranPersonne.ATTR_RECHERCHE).toString();
	if(ecran.equals(null)) ecran="";
	
	if(ecran.equals(IEcranPersonne.ATTR_ECRANLISTE)){
	%>
	<FORM method="get" action="../PersonneServlet" >
		<% 
		//initialisation des variables
		ArrayList<Personne> listePersonne=new ArrayList<Personne>();
		String urlDebut,urlModif,urlSuppr,urlFin;
		if(session.getAttribute(IEcranPersonne.ATTR_LISTEPERSONNE)!=null) listePersonne=(ArrayList<Personne>)session.getAttribute(IEcranPersonne.ATTR_LISTEPERSONNE);
		
		%>
		<H1>Recherche</H1>
		<INPUT TYPE="TEXT" NAME="<%= IEcranPersonne.NAME_RECHERCHE %>"/>
		<INPUT TYPE="SUBMIT" NAME="<%= IEcranPersonne.NAME_ACTION %>" VALUE="<%=IEcranPersonne.VALUE_RECHERCHER%>"/><BR/>
		<INPUT TYPE="SUBMIT" NAME="<%= IEcranPersonne.NAME_ACTION %>" VALUE="<%=IEcranPersonne.VALUE_CREER%>"/><BR/>
		<UL>
			<%
			urlDebut="../PersonneServlet?"+ IEcranPersonne.NAME_ACTION +"=";
			urlFin="&"+IEcranPersonne.NAME_ID+"=";
			urlModif=urlDebut+IEcranPersonne.VALUE_MODIFIER+urlFin;
			urlSuppr=urlDebut+IEcranPersonne.VALUE_SUPPRIMER+urlFin;
			
			for(int ii=0;ii<listePersonne.size();ii++){
			%>
			<LI>
				<a href="<%=urlSuppr+listePersonne.get(ii).getPerID() %>" >
					<IMG src="../img/delete.png" alt="supprimer"/>
				</a>
				<a href="<%=urlModif+listePersonne.get(ii).getPerID() %>" >
					<IMG src="../img/edit.png" alt="Éditer"/>
				</a>
				<SPAN>
					<%=
					listePersonne.get(ii).getPerNom()+ "&nbsp" +
					listePersonne.get(ii).getPerPrenom()+ "&nbsp" +
					listePersonne.get(ii).getCivilité().getLibLibelle()
					%>
				</SPAN>
			</LI>
			<%
			}
			session.removeAttribute(IEcranPersonne.ATTR_LISTEPERSONNE);
			%>
		</UL>
		
	</FORM>
	<%
	}
	if(ecran.equals(IEcranPersonne.ATTR_ECRANSAISIE)){
	%>
	<FORM method="POST" action="../PersonneServlet">
	<%
		Hashtable<String,String> tableErreurs=(Hashtable<String,String>)session.getAttribute(IEcranPersonne.ATTR_ERREURS);
		ArrayList<Libelle> listeCivilite=(ArrayList<Libelle>)session.getAttribute(IEcranPersonne.ATTR_LISTECIVILITE);
		ArrayList<Libelle> listePays=(ArrayList<Libelle>)session.getAttribute(IEcranPersonne.ATTR_LISTEPAYS);
		ArrayList<Libelle> listeNationalite=(ArrayList<Libelle>)session.getAttribute(IEcranPersonne.ATTR_LISTENATIONALITE);
		
		Integer id=((Integer)session.getAttribute(IEcranPersonne.ATTR_ID));
		
		Libelle civilite=Libelle.select("CIV",((Integer)session.getAttribute(IEcranPersonne.ATTR_CIVID)).intValue()),
		pays=Libelle.select("PAY",((Integer)session.getAttribute(IEcranPersonne.ATTR_PAYID)).intValue()),
		nationalite=Libelle.select("NAT",((Integer)session.getAttribute(IEcranPersonne.ATTR_NATID)).intValue());
		
		String selectedLibelle="",selectedCreation="",nom=(String)session.getAttribute(IEcranPersonne.ATTR_NOM),
		prenom=(String)session.getAttribute(IEcranPersonne.ATTR_PRENOM),
		commentaire=(String)session.getAttribute(IEcranPersonne.ATTR_COMMENTAIRE),
		action=(String)session.getAttribute(IEcranPersonne.ATTR_BUTACTION),
		validation=IEcranPersonne.VALUE_VALIDER,
		erreurNom="",erreurPrenom="",erreurCivilite="";
		
		if(action==null) action="";
		if(action.equals(IEcranPersonne.VALUE_SUPPRIMER)) validation=IEcranPersonne.VALUE_CONFIRMER;
		if(action.equals(IEcranPersonne.VALUE_CREER)) selectedCreation="selected";
		if(tableErreurs!=null){
			if(tableErreurs.containsKey(TablePersonne.PERNOM)) erreurNom=tableErreurs.get(TablePersonne.PERNOM);
			if(tableErreurs.containsKey(TablePersonne.PERPRENOM)) erreurPrenom=tableErreurs.get(TablePersonne.PERPRENOM);
			if(tableErreurs.containsKey(TablePersonne.PERLIBIDCIV)) erreurCivilite=tableErreurs.get(TablePersonne.PERLIBIDCIV);			
		}
	%>
		<H1>Saisie</H1>
		<INPUT TYPE="text" NAME="<%= IEcranPersonne.NAME_BUTACTION %>" VALUE="<%= action%>" />
		<INPUT TYPE="text" NAME="<%= IEcranPersonne.NAME_ID %>" VALUE="<%= id%>" />
		<P>Nom : <INPUT TYPE="text" NAME="<%= IEcranPersonne.NAME_NOM %>" VALUE="<%= nom %>" />
			<SPAN>&nbsp &nbsp <%= erreurNom %></SPAN>
		</P>
		<P>Prénom : <INPUT TYPE="text" NAME="<%= IEcranPersonne.NAME_PRENOM %>" VALUE="<%= prenom%>" />
			<SPAN>&nbsp &nbsp <%= erreurPrenom %></SPAN>
		</P>
		<P>Civilité : <SELECT NAME="<%= IEcranPersonne.NAME_CIVID %>">
		
		<%
		for(int ii=0;ii<listeCivilite.size();ii++){
			if(listeCivilite.get(ii).getLibId()==civilite.getLibId()){
				selectedLibelle="selected" ;
			}
		%>
		<OPTION VALUE="<%= listeCivilite.get(ii).getLibId()%>" SELECTED="<%= selectedLibelle %>" >
			<%= listeCivilite.get(ii).getLibLibelle() %>
		</OPTION>
		<%
		selectedLibelle="" ;
		}
		%>	
		</SELECT><SPAN>&nbsp &nbsp <%= erreurCivilite%></SPAN></P>
		
		<P>Pays :<SELECT NAME="<%= IEcranPersonne.NAME_PAYID %>">
			<OPTION VALUE="" selected="<%= selectedCreation %>"></OPTION>
		<%
		for(int ii=0;ii<listePays.size();ii++){
		/*	if(listePays.get(ii).getLibId()==pays.getLibId()){
				selectedLibelle="selected" ;
			}*/
		%>
			<OPTION VALUE="<%= listePays.get(ii).getLibId()%>" SELECTED="<%= selectedLibelle %>" >
				<%= listePays.get(ii).getLibLibelle() %>
			</OPTION>	
		<%
		selectedLibelle="" ;
		}
		%>
		</SELECT></P>
		<P>Nationalité : <SELECT NAME="<%= IEcranPersonne.NAME_NATID %>">
			
			<OPTION VALUE="" selected=" selected "></OPTION>
		<%
		for(int ii=0;ii<listeNationalite.size();ii++){
			/*if(listeNationalite.get(ii).getLibId()==nationalite.getLibId()){
				selectedLibelle="selected" ;
			}*/
		%>
			
			<OPTION VALUE="<%= listeNationalite.get(ii).getLibId()%>" SELECTED="<%= selectedLibelle %>">
				<%= listeNationalite.get(ii).getLibLibelle() %>
			</OPTION>	
		<%
		selectedLibelle="" ;
		}
		%>
		</SELECT></P>
		<P>Commentaires : <TEXTAREA NAME="<%= IEcranPersonne.NAME_COMMENTAIRE %>" VALUE="<%=commentaire %>" ></TEXTAREA></P>
		<INPUT TYPE="submit" NAME="<%= IEcranPersonne.NAME_ACTION %>" value="<%= IEcranPersonne.VALUE_ANNULER %>"/>
		<INPUT TYPE="submit" NAME="<%= IEcranPersonne.NAME_ACTION %>" value="<%= IEcranPersonne.VALUE_VALIDER %>"/>
	</FORM>
	<% 
		session.removeAttribute(IEcranPersonne.ATTR_ID );
		session.removeAttribute(IEcranPersonne.ATTR_NOM );
		session.removeAttribute(IEcranPersonne.ATTR_PRENOM );
		session.removeAttribute(IEcranPersonne.ATTR_CIVID );
		session.removeAttribute(IEcranPersonne.ATTR_PAYID );
		session.removeAttribute(IEcranPersonne.ATTR_NATID );
		session.removeAttribute(IEcranPersonne.ATTR_COMMENTAIRE );
		session.removeAttribute(IEcranPersonne.ATTR_ERREURS );
		session.removeAttribute(IEcranPersonne.ATTR_BUTACTION );
	}
	session.removeAttribute(IEcranPersonne.ATTR_LISTEPERSONNE);
	session.removeAttribute(IEcranPersonne.ATTR_LISTECIVILITE);
	session.removeAttribute(IEcranPersonne.ATTR_LISTEPAYS);
	session.removeAttribute(IEcranPersonne.ATTR_LISTENATIONALITE);
	%>
</body>
</html>